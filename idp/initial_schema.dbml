// Copyright (c) 2025 Afonso Barracha
// 
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.


Enum kek_usage {
    "global"
    "account"
}

Table key_encryption_keys as KEK {
    id serial [pk]
    
    kid uuid [not null]
    usage kek_usage [not null]
    version integer [not null, default: 1]
    rotated_at timestamptz [not null, default: `now()`]
    next_rotation_at timestamptz [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (kid) [unique, name: 'key_encryption_keys_kid_uidx']
        (usage) [name: 'key_encryption_keys_usage_idx']
        (kid, usage) [unique, name: 'key_encryption_keys_kid_usage_uidx']
    }
}

Enum dek_usage {
    "global"
    "account"
    "user"
}

Table data_encryption_keys as DEK {
    id serial [pk]
    
    kid varchar(22) [not null]
    dek text [not null]
    kek_kid uuid [not null]
    usage dek_usage [not null]
    is_revoked boolean [not null, default: false]
    expires_at timestamptz [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (kid) [unique, name: 'data_encryption_keys_kid_uidx']
        (expires_at) [name: 'data_encryption_keys_expires_at_idx']
        (is_revoked, expires_at) [name: 'data_encryption_keys_is_revoked_expires_at_idx']
        (usage, is_revoked, expires_at) [name: 'data_encryption_keys_usage_is_revoked_expires_at_idx']
        (kek_kid) [name: 'data_encryption_keys_kek_kid_idx']
    }
}
Ref: DEK.kek_kid > KEK.kid [delete: cascade, update: cascade]

Enum token_crypto_suite {
    "ES256"
    "EdDSA"
}

Enum token_key_usage {
    "global"
    "account"
}

Enum token_key_type {
    "access"
    "refresh"
    "id_token"
    "client_credentials"
    "email_verification"
    "password_reset"
    "2fa_authentication"
    "dynamic_registration"
}

Table token_signing_keys as TS {
    id serial [pk]
    
    kid varchar(22) [not null]
    key_type token_key_type [not null]
    public_key jsonb [not null]
    private_key text [not null]
    dek_kid varchar(22) [not null]
    crypto_suite token_crypto_suite [not null]

    expires_at timestamptz [not null]
    usage token_key_usage [not null, default: 'account']
    is_distributed boolean [not null, default: false]
    is_revoked boolean [not null, default: false]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (kid) [unique, name: 'token_signing_keys_kid_uidx']
        (expires_at) [name: 'token_signing_keys_expires_at_idx']
        (is_distributed, is_revoked, expires_at) [name: 'token_signing_keys_is_distributed_is_revoked_expires_at_idx']
        (key_type, usage, is_revoked, expires_at) [name: 'token_signing_keys_key_type_usage_is_revoked_expires_at_idx']
        (usage, is_distributed, is_revoked, expires_at) [name: 'token_signing_keys_usage_is_distributed_is_revoked_expires_at_idx']
        (kid, is_revoked) [name: 'token_signing_keys_kid_is_revoked_idx']
        (dek_kid) [name: 'token_signing_keys_dek_kid_idx']
    }
}
Ref: TS.dek_kid > DEK.kid [delete: cascade, update: cascade]

Enum two_factor_type {
    "none"
    "totp"
    "email"
}

Table accounts as A {
    id serial [pk]
    public_id uuid [not null]
    
    given_name varchar(100) [not null]
    family_name varchar(100) [not null]
    username varchar(63) [not null] // maximum length of a DNS label
    email varchar(250) [not null]
    organization varchar(50)
    password text
    version integer [not null, default: 1]
    email_verified boolean [not null, default: false]

    is_active boolean [not null, default: true]
    two_factor_type two_factor_type [not null, default: 'none']

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (email) [unique, name: 'accounts_email_uidx']
        (public_id) [unique, name: 'accounts_public_id_uidx']
        (public_id, version) [name: 'accounts_public_id_version_idx']
        (username) [unique, name: 'accounts_username_uidx']
    }
}

Enum totp_usage {
    "account"
    "user"
}

Table totps as TP {
    id serial [pk]

    dek_kid varchar(22) [not null]
    url varchar(512) [not null]
    secret text [not null]
    recovery_codes jsonb [not null]
    usage totp_usage [not null]

    account_id integer [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (dek_kid) [name: 'accounts_totps_dek_kid_idx']
        (account_id) [name: 'accounts_totps_account_id_idx']
    }
}
Ref: TP.dek_kid > DEK.kid [delete: cascade, update: cascade]
Ref: TP.account_id > A.id [delete: cascade]

Enum credentials_usage {
    "account"
    "app"
    "user"
}

Enum secret_storage_mode {
    "hashed" // Store secrets as hashes
    "encrypted" // Store secrets encrypted with a data encryption key
}

Table credentials_secrets as CS {
    id serial [pk]

    secret_id varchar(22) [not null]
    client_secret text [not null]
    storage_mode secret_storage_mode [not null]
    dek_kid varchar(22) [null]
    is_revoked boolean [not null, default: false]
    usage credentials_usage [not null]

    account_id integer [not null]

    expires_at timestamptz [not null]
    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (secret_id) [unique, name: 'credential_secrets_secret_id_uidx']
        (expires_at) [name: 'credential_secrets_expires_at_idx']
        (is_revoked, usage, expires_at) [name: 'credential_secrets_is_revoked_usage_expires_at_idx']
        (secret_id, is_revoked, expires_at) [name: 'credential_secrets_secret_id_is_revoked_expires_at_idx']
        (dek_kid) [name: 'credential_secrets_dek_kid_idx']
        (account_id) [name: 'credential_secrets_account_id_idx']
    }
}
Ref: CS.account_id > A.id [delete: cascade]
Ref: CS.dek_kid > DEK.kid [delete: cascade, update: cascade]

Table credentials_keys as CK {
    id serial [pk]

    public_kid varchar(22) [not null]
    public_key jsonb [not null]
    crypto_suite token_crypto_suite [not null]
    is_revoked boolean [not null, default: false]
    usage credentials_usage [not null]

    account_id integer [not null]

    expires_at timestamptz [not null]
    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (public_kid) [unique, name: 'credential_keys_public_kid_uidx']
        (expires_at) [name: 'credential_keys_expires_at_idx']
        (is_revoked, usage, expires_at) [name: 'credential_keys_is_revoked_usage_expires_at_idx']
        (public_kid, crypto_suite, usage, is_revoked, expires_at) [name: 'credential_keys_public_kid_crypto_suite_usage_is_revoked_expires_at_idx']
    }
}
Ref: CK.account_id > A.id [delete: cascade]

Table account_key_encryption_keys as AKEK {
    account_id integer [not null]
    key_encryption_key_id integer [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id, key_encryption_key_id) [pk]
        (account_id) [name: 'account_key_encryption_keys_account_id_idx']
        (key_encryption_key_id) [unique, name: 'account_key_encryption_keys_key_encryption_key_id_uidx']
        (account_id, key_encryption_key_id) [unique, name: 'account_key_encryption_keys_account_id_key_encryption_key_id_uidx']
    }
}
Ref: AKEK.account_id > A.id [delete: cascade]
Ref: AKEK.key_encryption_key_id > KEK.id [delete: cascade]

Table account_data_encryption_keys as ADEK {
    account_id integer [not null]
    data_encryption_key_id integer [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id, data_encryption_key_id) [pk]
        (account_id) [name: 'account_data_encryption_keys_account_id_idx']
        (data_encryption_key_id) [unique, name: 'account_data_encryption_keys_data_encryption_key_id_uidx']
        (account_id, data_encryption_key_id) [unique, name: 'account_data_encryption_keys_account_id_data_encryption_key_id_uidx']
    }
}
Ref: ADEK.account_id > A.id [delete: cascade]
Ref: ADEK.data_encryption_key_id > DEK.id [delete: cascade]

Table account_hmac_secrets as AHS {
    id serial [pk]

    account_id integer [not null]

    secret_id varchar(22) [not null]
    secret text [not null]
    dek_kid varchar(22) [not null]
    is_revoked boolean [not null, default: false]
    expires_at timestamptz [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [name: 'account_hmac_secrets_account_id_idx']
        (secret_id) [unique, name: 'account_hmac_secrets_secret_id_uidx']
        (dek_kid) [name: 'account_hmac_secrets_dek_kid_idx']
        (account_id, secret_id) [name: 'account_hmac_secrets_account_id_secret_id_idx']
        (account_id, is_revoked, expires_at) [name: 'account_hmac_secrets_account_id_is_revoked_expires_at_idx']
    }
}
Ref: AHS.account_id > A.id [delete: cascade]
Ref: AHS.dek_kid > DEK.kid [delete: cascade, update: cascade]

Table account_totps as AT {
    account_id integer [not null]
    totp_id integer [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id, totp_id) [pk]
        (account_id) [unique, name: 'accounts_totps_account_id_uidx']
        (totp_id) [unique, name: 'accounts_totps_totp_id_uidx']
        (account_id, totp_id) [unique, name: 'accounts_totps_account_id_totp_id_uidx']
    }
}
Ref: AT.account_id > A.id [delete: cascade]
Ref: AT.totp_id > TP.id [delete: cascade]

Enum auth_method {
    "none"
    "client_secret_basic"
    "client_secret_post"
    "client_secret_jwt"
    "private_key_jwt"
}

Enum response_type {
    "code"
    "id_token"
    "code id_token"
}

Enum account_credentials_scope {
    "email"
    "profile"
    "account:admin"
    "account:users:read"
    "account:users:write"
    "account:apps:read"
    "account:apps:write"
    "account:apps:configs:read"
    "account:apps:configs:write"
    "account:credentials:read"
    "account:credentials:write"
    "account:credentials:configs:read"
    "account:credentials:configs:write"
    "account:auth_providers:read"
}

Enum account_credentials_type {
    "native"
    "service"
    "mcp"
}

Enum transport {
    "http"
    "https"
    "stdio"
    "streamable_http"
}

Enum creation_method {
    "manual"
    "dynamic_registration"
}

Table account_credentials as AC {
    id serial [pk]

    account_id integer [not null]
    account_public_id uuid [not null]

    client_id varchar(22) [not null]
    name varchar(255) [not null]
    domain "varchar(250)" [not null]
    credentials_type account_credentials_type [not null]
    scopes "account_credentials_scope[]" [not null]
    token_endpoint_auth_method "auth_method" [not null]
    grant_types "grant_type[]" [not null]
    version integer [not null, default: 1]

    transport transport [not null]
    creation_method creation_method [not null]

    client_uri varchar(512) [not null]
    redirect_uris "varchar(2048)[]" [not null]
    logo_uri varchar(512) [null]
    policy_uri varchar(512) [null]
    tos_uri varchar(512) [null]
    software_id varchar(512) [not null]
    software_version varchar(512) [null]
    contacts "varchar(250)[]" [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (client_id) [unique, name: 'account_credentials_client_id_uidx']
        (account_id) [name: 'account_credentials_account_id_idx']
        (account_public_id) [name: 'account_credentials_account_public_id_idx']
        (account_public_id, client_id) [name: 'account_credentials_account_public_id_client_id_idx']
        (name, account_id) [unique, name: 'account_credentials_name_account_id_uidx']
    }
}
Ref: AC.account_id > A.id [delete: cascade]

Table account_credentials_secrets as ACS {
    account_id integer [not null]
    credentials_secret_id integer [not null]

    account_credentials_id integer [not null]
    account_public_id uuid [not null]
    secret_id varchar(22) [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id, credentials_secret_id) [pk]
        (account_id) [name: 'account_credential_secrets_account_id_idx']
        (account_public_id) [name: 'account_credential_secrets_account_public_id_idx']
        (credentials_secret_id) [unique, name: 'account_credential_secrets_credentials_secret_id_uidx']
        (account_credentials_id) [name: 'account_credential_secrets_account_credentials_id_idx']
        (account_credentials_id, secret_id) [name: 'account_credential_secrets_account_credentials_id_secret_id_idx']
    }
}
Ref: ACS.account_id > A.id [delete: cascade]
Ref: ACS.credentials_secret_id > CS.id [delete: cascade]

Table account_credentials_keys as ACK {
    account_id integer [not null]
    credentials_key_id integer [not null]

    account_credentials_id integer [not null]
    account_public_id uuid [not null]
    jwk_kid varchar(22) [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id, credentials_key_id) [pk]
        (account_id) [name: 'account_credentials_keys_account_id_idx']
        (credentials_key_id) [unique, name: 'account_credentials_keys_credentials_key_id_uidx']
        (account_credentials_id) [name: 'account_credentials_keys_account_credentials_id_idx']
        (account_public_id) [name: 'account_credentials_keys_account_public_id_idx']
        (account_credentials_id, jwk_kid) [name: 'account_credentials_account_credentials_id_keys_jwk_kid_idx']
    }
}
Ref: ACK.account_id > A.id [delete: cascade]
Ref: ACK.account_credentials_id > AC.id [delete: cascade]
Ref: ACK.credentials_key_id > CK.id [delete: cascade]


Enum auth_provider {
    "local"
    "apple"
    "facebook"
    "github"
    "google"
    "microsoft"
}

Table account_auth_providers as AP {
    id serial [pk]
    
    email varchar(250) [not null]
    provider auth_provider [not null]
    account_public_id uuid [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        email [name: 'auth_providers_email_idx']
        (email, provider) [unique, name: 'auth_providers_email_provider_uidx']
        account_public_id [name: 'auth_providers_account_public_id_idx']
        (account_public_id, email) [name: 'auth_providers_account_public_id_email_idx']
    }
}
Ref: AP.email > A.email [delete: cascade, update: cascade]

Enum claims {
    "sub"
    "name"
    "given_name"
    "family_name"
    "middle_name"
    "nickname"
    "preferred_username"
    "profile"
    "picture"
    "website"
    "email"
    "email_verified"
    "gender"
    "birthdate"
    "zoneinfo"
    "locale"
    "phone_number"
    "phone_number_verified"
    "address"
    "updated_at"
}

Enum scopes {
    "openid"
    "email"
    "profile"
    "address"
    "phone"
}

Table oidc_configs as OIDC {
    id serial [pk]

    account_id integer [not null]

    claims_supported "claims[]" [not null, default: '{ "sub", "email", "email_verified", "given_name", "family_name" }']
    scopes_supported "scopes[]" [not null, default: '{ "openid", "email", "profile" }']
    custom_claims "varchar(512)[]" [not null, default: '{}']
    custom_scopes "varchar(512)[]" [not null, default: '{}']

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [unique, name: 'oidc_configs_account_id_uidx']
    }
}
Ref: OIDC.account_id > A.id [delete: cascade]

Table account_token_signing_keys as ATSK {
    account_id integer [not null]
    token_signing_key_id integer [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id, token_signing_key_id) [pk]
        (account_id) [name: 'account_token_signing_keys_account_id_idx']
        (token_signing_key_id) [unique, name: 'account_token_signing_keys_token_signing_key_id_uidx']
        (account_id, token_signing_key_id) [unique, name: 'account_token_signing_keys_account_id_token_signing_key_id_uidx']
    }
}
Ref: ATSK.account_id > A.id [delete: cascade]
Ref: ATSK.token_signing_key_id > TS.id [delete: cascade]

Table users as U {
    id serial [pk]

    public_id uuid [not null]
    account_id integer [not null]

    email varchar(250) [not null]
    username varchar(63) [not null] // maximum length of a DNS label
    password text
    version integer [not null, default: 1]
    email_verified boolean [not null, default: false]

    is_active boolean [not null, default: true]
    two_factor_type two_factor_type [not null, default: 'none']

    user_data jsonb [not null, default: '{}']

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id, email) [unique, name: 'users_account_id_email_uidx']
        (account_id, username) [unique, name: 'users_account_id_username_uidx']
        (account_id) [name: 'users_account_id_idx']
        (public_id) [unique, name: 'users_public_id_uidx']
        (public_id, version) [name: 'users_public_id_version_idx']
    }
}
Ref: U.account_id > A.id [delete: cascade]

Table user_data_encryption_keys as UDEK {
    user_id integer [not null]
    data_encryption_key_id integer [not null]

    account_id integer [not null]
    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (user_id, data_encryption_key_id) [pk]
        (user_id) [name: 'user_data_encryption_keys_user_id_idx']
        (data_encryption_key_id) [unique, name: 'user_data_encryption_keys_data_encryption_key_id_uidx']
        (account_id) [name: 'user_data_encryption_keys_account_id_idx']
        (user_id, data_encryption_key_id) [unique, name: 'user_data_encryption_keys_user_id_data_encryption_key_id_uidx']
    }
}
Ref: UDEK.account_id > A.id [delete: cascade]
Ref: UDEK.user_id > U.id [delete: cascade]
Ref: UDEK.data_encryption_key_id > DEK.id [delete: cascade]

Table user_totps as UT {
    user_id integer [not null]
    totp_id integer [not null]

    account_id integer [not null]
    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (user_id, totp_id) [pk]
        (user_id) [unique, name: 'user_totps_user_id_uidx']
        (totp_id) [unique, name: 'user_totps_totp_id_uidx']
        (account_id) [name: 'user_totps_account_id_idx']
        (user_id, totp_id) [unique, name: 'user_totps_user_id_totp_id_uidx']
    }
}
Ref: UT.account_id > A.id [delete: cascade]
Ref: UT.user_id > U.id [delete: cascade]
Ref: UT.totp_id > TP.id [delete: cascade]

Table user_auth_providers as UAP {
    id serial [pk]

    user_id integer [not null]
    account_id integer [not null]

    provider auth_provider [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        user_id [name: 'user_auth_provider_user_id_idx']
        (user_id, provider) [unique, name: 'user_auth_provider_user_id_provider_uidx']
        (account_id) [name: 'user_auth_provider_account_id_idx']
    }
}
Ref: UAP.account_id > A.id [delete: cascade]
Ref: UAP.user_id > U.id [delete: cascade]

Table user_credentials as UC {
    id serial [pk]

    user_id integer [not null]
    account_id integer [not null]
    app_id integer [not null]

    client_id varchar(22) [not null]
    auth_methods "auth_method[]" [not null]
    issuers "varchar(512)[]" [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (client_id) [unique, name: 'user_credentials_client_id_uidx']
        (user_id) [name: 'user_credentials_user_id_idx']
        (account_id) [name: 'user_credentials_account_id_idx']
        (app_id) [name: 'user_credentials_app_id_idx']
        (user_id, app_id) [unique, name: 'user_credentials_user_id_app_id_uidx']
    }
}
Ref: UC.user_id > U.id [delete: cascade]
Ref: UC.account_id > A.id [delete: cascade]
Ref: UC.app_id > APP.id [delete: cascade]

Table user_credentials_secrets as UCS {
    user_id integer [not null]
    credentials_secret_id integer [not null]

    user_credential_id integer [not null]
    account_id integer [not null]

    user_public_id uuid [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (user_id, credentials_secret_id) [pk]
        (user_id) [name: 'user_credentials_secrets_user_id_idx']
        (credentials_secret_id) [unique, name: 'user_credentials_secrets_credentials_secret_id_uidx']
        (account_id) [name: 'user_credentials_secrets_account_id_idx']
        (user_credential_id) [name: 'user_credentials_secrets_user_credential_id_idx']
        (user_public_id) [name: 'user_credentials_secrets_user_public_id_idx']
        (user_id, user_credential_id) [unique, name: 'user_credentials_secrets_user_id_user_credential_id_uidx']
    }
}
Ref: UCS.user_id > U.id [delete: cascade]
Ref: UCS.user_credential_id > UC.id [delete: cascade]
Ref: UCS.credentials_secret_id > CS.id [delete: cascade]
Ref: UCS.account_id > A.id [delete: cascade]

Table user_credentials_keys as UCK {
    user_id integer [not null]
    credentials_key_id integer [not null]

    user_credential_id integer [not null]
    account_id integer [not null]

    user_public_id uuid [not null]
    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (user_id, credentials_key_id) [pk]
        (user_id) [name: 'user_credentials_keys_user_id_idx']
        (credentials_key_id) [unique, name: 'user_credentials_keys_credentials_key_id_uidx']
        (account_id) [name: 'user_credentials_keys_account_id_idx']
        (user_credential_id) [name: 'user_credentials_keys_user_credential_id_idx']
        (user_public_id) [name: 'user_credentials_keys_user_public_id_idx']
        (user_id, user_credential_id) [unique, name: 'user_credentials_keys_user_id_user_credential_id_uidx']
    }
}
Ref: UCK.user_id > U.id [delete: cascade]
Ref: UCK.user_credential_id > UC.id [delete: cascade]
Ref: UCK.credentials_key_id > CK.id [delete: cascade]
Ref: UCK.account_id > A.id [delete: cascade]

Enum app_type {
    "web" // Web apps with server-side logic
    "native" // Native apps with client-side logic
    "spa" // Single-page apps
    "backend" // Backend apps
    "device" // Device apps
    "service" // Service apps
    "mcp" // Model Context Protocol apps
}

Enum app_username_column {
    "email"
    "username"
    "both"
}

Enum grant_type {
    "authorization_code"
    "refresh_token"
    "client_credentials"
    "urn:ietf:params:oauth:grant-type:device_code"
    "urn:ietf:params:oauth:grant-type:jwt-bearer"
}

Table apps as APP {
    id serial [pk]
    account_id integer [not null]

    account_public_id uuid [not null]

    app_type app_type [not null]
    name varchar(255) [not null]
    client_id varchar(22) [not null]
    version integer [not null, default: 1]
    creation_method creation_method [not null]

    // Common dynamic registration fields
    client_uri varchar(512) [not null]
    logo_uri varchar(512) [null]
    tos_uri varchar(512) [null]
    policy_uri varchar(512) [null]
    software_id varchar(250) [not null]
    software_version varchar(250) [null]
    contacts "varchar(250)[]" [not null]
    token_endpoint_auth_method "auth_method" [not null]
    scopes "scopes[]" [not null]
    custom_scopes "varchar(512)[]" [not null]
    grant_types "grant_type[]" [not null]

    // Common on all OAuth2 apps
    domain varchar(250) [not null]
    transport transport [not null]
    allow_user_registration bool [not null]
    auth_providers "auth_provider[]" [not null]
    username_column app_username_column [not null]
    default_scopes "scopes[]" [not null]
    default_custom_scopes "varchar(512)[]" [not null]

    // Apps with redirects
    redirect_uris "varchar(2048)[]" [not null]
    response_types "response_type[]" [not null]

    // Tokens TTLs
    id_token_ttl integer [not null, default: 300] // 5 minutes
    token_ttl integer [not null, default: 300] // 5 minutes
    refresh_token_ttl integer [not null, default: 604800] // 7 days

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [name: 'apps_account_id_idx']
        (app_type) [name: 'apps_app_type_idx']
        (client_id) [unique, name: 'apps_client_id_uidx']
        (client_id, account_public_id) [name: 'apps_client_id_account_public_id_idx']
        (account_public_id) [name: 'apps_account_public_id_idx']
        (name) [name: 'apps_name_idx']
        (account_id, name) [unique, name: 'apps_account_id_name_uidx']
        (account_id, app_type) [name: 'apps_account_id_app_type_idx']
    }
}
Ref: APP.account_id > A.id [delete: cascade]


Table app_secrets as APS {
    app_id integer [not null]
    credentials_secret_id integer [not null]

    account_id integer [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (app_id, credentials_secret_id) [pk]
        (app_id) [name: 'app_secrets_app_id_idx']
        (credentials_secret_id) [unique, name: 'app_secrets_credentials_secret_id_uidx']
        (account_id) [name: 'app_secrets_account_id_idx']
        (app_id, credentials_secret_id) [unique, name: 'app_secrets_app_id_credentials_secret_id_uidx']
    }
}
Ref: APS.account_id > A.id [delete: cascade]
Ref: APS.app_id > APP.id [delete: cascade]
Ref: APS.credentials_secret_id > CS.id [delete: cascade]

Table app_keys as APK {
    app_id integer [not null]
    credentials_key_id integer [not null]

    account_id integer [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (app_id, credentials_key_id) [pk]
        (app_id) [name: 'app_keys_app_id_idx']
        (credentials_key_id) [unique, name: 'app_keys_credentials_key_id_uidx']
        (account_id) [name: 'app_keys_account_id_idx']
        (app_id, credentials_key_id) [unique, name: 'app_keys_app_id_credentials_key_id_uidx']
    }
}
Ref: APK.account_id > A.id [delete: cascade]
Ref: APK.app_id > APP.id [delete: cascade]
Ref: APK.credentials_key_id > CK.id [delete: cascade]

Table app_related_apps as ARA {
    account_id integer [not null]
    app_id integer [not null]
    related_app_id integer [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (app_id, related_app_id) [pk]
        (account_id) [name: 'app_related_apps_account_id_idx']
        (app_id) [name: 'app_related_apps_app_id_idx']
        (related_app_id) [name: 'app_related_apps_related_app_id_idx']
        (app_id, related_app_id) [unique, name: 'app_related_apps_app_id_related_app_id_uidx']
    }
}
Ref: ARA.account_id > A.id [delete: cascade]
Ref: ARA.app_id > APP.id [delete: cascade]
Ref: ARA.related_app_id > APP.id [delete: cascade]

Table app_service_configs as ASCONF {
    id serial [pk]

    account_id integer [not null]
    app_id integer [not null]

    user_auth_method "auth_method" [not null]
    user_grant_types "grant_type[]" [not null]
    allowed_domains "varchar(250)[]" [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [name: 'app_service_configs_account_id_idx']
        (app_id) [unique, name: 'app_service_configs_app_id_uidx']
    }
}
Ref: ASCONF.account_id > A.id [delete: cascade]
Ref: ASCONF.app_id > APP.id [delete: cascade]

Table app_designs as AD {
    id serial [pk]

    account_id integer [not null]
    app_id integer [not null]

    light_colors jsonb [not null]
    dark_colors jsonb [null]

    logo_url varchar(512) [null]
    favicon_url varchar(512) [null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [name: 'app_designs_account_id_idx']
        (app_id) [unique, name: 'app_designs_app_id_uidx']
    }
}
Ref: AD.account_id > A.id [delete: cascade]
Ref: AD.app_id > APP.id [delete: cascade]

Enum initial_access_token_generation_method {
    "manual"
    "authorization_code"
}

Enum software_statement_verification_method {
    "manual"
    "jwks_uri"
}

Table account_dynamic_registration_configs as ADRC {
    id serial [pk]

    account_id integer [not null]
    account_public_id uuid [not null]

    account_credentials_types "account_credentials_type[]" [not null]
    whitelisted_domains "varchar(250)[]" [not null]
    require_software_statement_credential_types "account_credentials_type[]" [not null]
    software_statement_verification_methods "software_statement_verification_method[]" [not null]

    require_initial_access_token_credential_types "account_credentials_type[]" [not null]
    initial_access_token_generation_methods "initial_access_token_generation_method[]" [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [unique, name: 'account_dynamic_registration_configs_account_id_uidx']
        (account_public_id) [name: 'account_dynamic_registration_configs_account_public_id_idx']
    }
}
Ref: ADRC.account_id > A.id [delete: cascade]

Enum domain_verification_method {
    "authorization_code"
    "software_statement"
    "dns_txt_record"
}

Table account_dynamic_registration_domains as ADRD {
    id serial [pk]

    account_id integer [not null]
    account_public_id uuid [not null]

    domain varchar(250) [not null]
    verified_at timestamptz [null]
    verification_method domain_verification_method [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [name: 'accounts_totps_account_id_idx']
        (account_public_id) [name: 'account_dynamic_registration_domains_account_public_id_idx']
        (domain) [name: 'account_dynamic_registration_domains_domain_idx']
        (account_public_id, domain) [unique, name: 'account_dynamic_registration_domains_account_public_id_domain_uidx']
    }
}
Ref: ADRD.account_id > A.id [delete: cascade]

Table dynamic_registration_domain_codes as DRDC {
    id serial [pk]

    account_id integer [not null]
    verification_host varchar(50) [not null]
    verification_code text [not null]
    hmac_secret_id varchar(22) [not null]
    verification_prefix varchar(70) [not null]
    expires_at timestamptz [not null]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [name: 'account_dynamic_registration_domain_codes_account_id_idx']
    }
}
Ref: DRDC.account_id > A.id [delete: cascade]
Ref: DRDC.hmac_secret_id > AHS.secret_id [delete: cascade, update: cascade]

Table account_dynamic_registration_domain_codes as ADRDC {
    account_dynamic_registration_domain_id integer [not null]
    dynamic_registration_domain_code_id integer [not null]

    account_id integer [not null]
    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_dynamic_registration_domain_id, dynamic_registration_domain_code_id) [pk]
        (account_id) [name: 'account_dynamic_registration_domain_codes_account_id_idx']
        (account_dynamic_registration_domain_id) [unique, name: 'account_dynamic_registration_domain_codes_account_dynamic_registration_domain_id_uidx']
        (dynamic_registration_domain_code_id) [unique, name: 'account_dynamic_registration_domain_codes_dynamic_registration_domain_code_id_uidx']
    }
}
Ref: ADRDC.account_id > A.id [delete: cascade]
Ref: ADRDC.account_dynamic_registration_domain_id > ADRD.id [delete: cascade]
Ref: ADRDC.dynamic_registration_domain_code_id > DRDC.id [delete: cascade]

Table app_dynamic_registration_configs as APDRC {
    id serial [pk]

    account_id integer [not null]

    allowed_app_types "app_type[]" [not null]
    whitelisted_domains "varchar(250)[]" [not null]
    default_allow_user_registration boolean [not null]
    default_auth_providers "auth_provider[]" [not null]
    default_username_column app_username_column [not null]
    default_allowed_scopes "scopes[]" [not null]
    default_scopes "scopes[]" [not null]

    require_software_statement_app_types "app_type[]" [not null]
    software_statement_verification_methods "software_statement_verification_method[]" [not null]

    require_initial_access_token_app_types "app_type[]" [not null]
    initial_access_token_generation_methods "initial_access_token_generation_method[]" [not null]
    initial_access_token_ttl  integer [not null, default: 3600] // 1 hour
    initial_access_token_max_uses int [not null, default: 1]

    allowed_grant_types "grant_type[]" [not null, default: '{ "authorization_code", "refresh_token", "client_credentials", "urn:ietf:params:oauth:grant-type:device_code", "urn:ietf:params:oauth:grant-type:jwt-bearer" }']
    allowed_response_types "response_type[]" [not null, default: '{ "code", "id_token", "code id_token" }']
    allowed_token_endpoint_auth_methods "auth_method[]" [not null, default: '{ "none", "client_secret_post", "client_secret_basic", "client_secret_jwt", "private_key_jwt" }']
    max_redirect_uris int [not null, default: 10]

    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]

    Indexes {
        (account_id) [name: 'app_dynamic_registration_configs_account_id_idx']
    }
}
Ref: APDRC.account_id > A.id [delete: cascade]

Enum app_profile_type {
    "human"
    "machine"
    "ai_agent"
}

Table app_profiles as AUP {
    app_id integer [not null]
    user_id integer [not null]

    account_id integer [not null]
    profile_type app_profile_type [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (app_id, user_id) [pk]
        (app_id) [name: 'user_profiles_app_id_idx']
        (user_id) [name: 'user_profiles_user_id_idx']
        (account_id) [name: 'user_profiles_account_id_idx']
        (user_id, app_id) [unique, name: 'user_profiles_user_id_app_id_uidx']
    }
}
Ref: AUP.app_id > APP.id [delete: cascade]
Ref: AUP.user_id > U.id [delete: cascade]
Ref: AUP.account_id > A.id [delete: cascade]

Enum token_owner {
    "user"
    "account"
}

Table revoked_tokens as RT {
    id serial [pk]

    token_id uuid [not null]

    account_id integer [not null]
    owner token_owner [not null]
    owner_public_id uuid [not null]
    issued_at timestamptz [not null]
    expires_at timestamptz [not null]

    created_at timestamptz [not null, default: `now()`]

    Indexes {
        (token_id) [unique, name: 'revoked_tokens_token_id_uidx']
        (account_id) [name: 'revoked_tokens_account_id_idx']
        (expires_at) [name: 'revoked_tokens_expires_at_idx']
    }
}
Ref: RT.account_id > A.id [delete: cascade]

